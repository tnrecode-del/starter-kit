-- Таблица агентских метрик  
CREATE TABLE agent_execution_metrics (  
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),  
    task_id VARCHAR(50) NOT NULL REFERENCES execution_logs(task_id),  
    agent_id VARCHAR(50) NOT NULL,  
      
    -- Общие файловые метрики  
    files_created INTEGER DEFAULT 0,  
    files_modified INTEGER DEFAULT 0,  
    files_deleted INTEGER DEFAULT 0,  
    lines_added INTEGER DEFAULT 0,  
    lines_removed INTEGER DEFAULT 0,  
      
    -- Качество  
    type_errors_before INTEGER DEFAULT 0,  
    type_errors_after INTEGER DEFAULT 0,  
    lint_errors_before INTEGER DEFAULT 0,  
    lint_errors_after INTEGER DEFAULT 0,  
      
    -- Специфичные метрики (JSONB для гибкости)  
    role_specific JSONB NOT NULL DEFAULT '{}',  
      
    created_at TIMESTAMPTZ DEFAULT NOW(),  
      
    UNIQUE(task_id, agent_id)  
);  
  
-- Индексы для аналитики по агентам  
CREATE INDEX idx_agent_metrics_agent ON agent_execution_metrics(agent_id);  
CREATE INDEX idx_agent_metrics_task ON agent_execution_metrics(task_id);  
CREATE INDEX idx_agent_metrics_role ON agent_execution_metrics USING GIN(role_specific);  
  
-- Представление для агрегированных метрик задачи  
CREATE VIEW task_code_summary AS  
SELECT   
    task_id,  
    SUM(files_created) as total_files_created,  
    SUM(files_modified) as total_files_modified,  
    SUM(lines_added) as total_lines_added,  
    SUM(lines_removed) as total_lines_removed,  
    MAX(type_errors_after) as max_type_errors,  
    BOOL_AND(type_errors_after = 0) as zero_type_errors,  
    JSON_AGG(  
        JSON_BUILD_OBJECT(  
            'agent_id', agent_id,  
            'files_created', files_created,  
            'role_specific', role_specific  
        )  
    ) as agent_breakdown  
FROM agent_execution_metrics  
GROUP BY task_id;  
