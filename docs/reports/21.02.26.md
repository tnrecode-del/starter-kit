# AI Infrastructure Setup — Agent System v4
**Дата:** 21.02.2026
**Тип:** Implementation Report + Architectural Review + Fix Log

---

## 1. Контекст

Интеграция готовых исходников Agent System v4 из `docs/ai-infra/` в монорепо:
- Подключение MCP серверов к Claude Code
- Создание 6 суб-агентных файлов
- Перенос системы в `packages/ai-agents/`
- Расширение Docker Compose (Redis + ChromaDB)
- Обновление окружения и Turborepo конфигурации

---

## 2. Реализованный план

### Шаг 1 — `.mcp.json`
Создан файл с 5 MCP серверами: `filesystem`, `postgres`, `git`, `playwright`, `shadcn`.

### Шаг 2 — `.claude/agents/` (6 суб-агентов)

| Файл | Агент | Цвет | MCP |
|------|-------|------|-----|
| `architect.md` | Security audit, quality gate | purple | — |
| `frontend-ui.md` | React 19, Tailwind v4, shadcn/ui, a11y | cyan | filesystem, shadcn |
| `frontend-bizlogic.md` | Zustand, Zod, TanStack Query | blue | filesystem |
| `backend-api.md` | NestJS 11, JWT/OAuth2, guards, DTOs | orange | filesystem |
| `backend-database.md` | Prisma 7, PostgreSQL, migrations | green | filesystem, postgres |
| `qa-testing.md` | Vitest, Playwright E2E, visual regression | yellow | playwright, filesystem |

Уже существовал: `orchestrator.md` (не изменялся).

### Шаг 3 — `packages/ai-agents/`
Пакет `@core/ai-agents` создан из `docs/ai-infra/`. Адаптации:
- `name: "@core/ai-agents"`, `"private": true`
- `type: "module"` + `tsconfig.json` с `moduleResolution: NodeNext`
- `pnpm` вместо `npm` в `engines`

Файлы: `types.ts`, `sub_agents_config.ts`, `orchestrator_v4.ts`, `mcp_framework_v4.ts`, `vector_store.ts`, `task_queue.ts`, `telegram_bot_handler.ts`, `regression_testing_v4.ts`

### Шаг 4 — `docker-compose.yml`
Добавлены сервисы `redis:7-alpine` (6379) и `chromadb/chroma:latest` (8000).

### Шаг 5 — `.env.example` + `turbo.json`
`.env.example` создан с секцией AI Infrastructure. В `turbo.json` добавлены `typecheck` и `start:queue`.

---

## 3. Архитектурный ревью

**Инструмент:** sub-agent `architect-reviewer` + `general-purpose` Task agent
**Architectural Impact:** High — система пересекает все ключевые границы монорепо

### 3.1 Критические баги (обнаружено 13)

#### Группа А — Конфигурация (`.mcp.json`)
| # | Проблема | Severity |
|---|----------|----------|
| 1 | `playwright` entry: `command: "npx"` без `args` — сервер не стартует | Critical |
| 2 | `postgres` credentials как positional CLI arg — видны в `ps aux` и shell history | Critical |

#### Группа Б — Package (runtime deps в devDependencies)
| # | Проблема | Severity |
|---|----------|----------|
| 3 | `bullmq`, `chromadb`, `ioredis`, `nanoid`, `pino`, `dotenv`, `axios`, `@anthropic-ai/sdk`, `@google/generative-ai` — все в `devDependencies`. В production: `Cannot find module` при старте | Critical |

#### Группа В — Side effects при импорте
| # | Проблема | Severity |
|---|----------|----------|
| 4 | `orchestrator_v4.ts`: `main()` вызывается на уровне модуля, `export` закомментирован. Любой `import MVPOrchestrator` запускает 24/7 loop | Critical |
| 5 | `task_queue.ts`: та же проблема — `main()` + `// export { FeatureQueue }` | Critical |

#### Группа Г — Runtime баги в TypeScript
| # | Проблема | Severity |
|---|----------|----------|
| 6 | `vector_store.ts:243` — `.replace("-", "_")` (не global) → `frontend-bizlogic` коллекция не находится → `Collection not found` crash | Critical |
| 7 | `orchestrator_v4.ts:517` — Gemini cost считается по ценам Sonnet (`calculateCost("sonnet", ...)`) — в 40x дороже реального. Ложные budget-exhaustion shutdowns | High |
| 8 | `orchestrator_v4.ts:387` — `(params as any).thinking` — обход типизации | Medium |

#### Группа Д — Schema mismatch
| # | Проблема | Severity |
|---|----------|----------|
| 9 | `architect.md` output: `{ guidelines: { componentGuidelines, stateGuidelines, apiDesign... } }` | High |
|   | `buildArchitectPrompt()` запрашивает: `{ guidelines: { frontend, backend, database, security } }` | |
|   | `HANDOFF_RULES` ожидает поля из `.md` схемы → handoff context всегда пустой | |
| 10 | `mcp_framework_v4.ts:72` — playwright пакет `@anthropic/mcp-playwright` (не существует) вместо `@playwright/mcp` | High |
| 11 | `sub_agents_config.ts:72` — `mcpServers: ["filesystem-mcp-server", "shadcn"]` — имя `"shadcn"` не соответствует ни одному ключу в `MCP_SERVER_CONFIGS` | High |

#### Группа Е — Infrastructure
| # | Проблема | Severity |
|---|----------|----------|
| 12 | `docker-compose.yml` — нет `healthcheck` ни на одном сервисе → race condition при `docker compose up` | Medium |
| 13 | `docker-compose.yml:2` — `postgres:16-alpine`, документация описывает PostgreSQL 17 | Low |

### 3.2 Gaps и упущения

| Gap | Описание |
|-----|----------|
| `turbo.json` | `start:queue` без `dependsOn: ["build"]` — можно запустить до компиляции |
| `.env.example` | Отсутствует `BASE_URL` (используется в `loadConfig()` и `regression_testing_v4.ts`) |
| `pnpm-workspace.yaml` | Не верифицировано включение `packages/ai-agents` в workspace |
| Dual-protocol | `.claude/agents/*.md` и `sub_agents_config.ts` — два независимых описания одних агентов, будут расходиться |
| Budget persistence | `monthlySpend` — in-memory, `sessionId = "session_" + Date.now()` → новый ID при каждом рестарте → бюджет обнуляется |
| Context-manager | Незадокументированный 7-й агент в `sub_agents_config.ts` и `orchestrator_v4.ts`, отсутствует в `orchestrator.md` |

---

## 4. Применённые исправления

### Fix 1 — `.mcp.json`: playwright args
```json
// До
"playwright": { "command": "npx" }

// После
"playwright": {
  "command": "npx",
  "args": ["-y", "@playwright/mcp@latest"]
}
```

### Fix 2 — `.mcp.json`: postgres credentials → env
```json
// До
"args": ["-y", "@modelcontextprotocol/server-postgres", "postgresql://user:password@..."]

// После
"args": ["-y", "@modelcontextprotocol/server-postgres"],
"env": { "DATABASE_URL": "postgresql://user:password@localhost:5432/mydb" }
```

### Fix 3 — `package.json`: runtime deps
Перенесены в `dependencies`: `@anthropic-ai/sdk`, `@google/generative-ai`, `axios`, `bullmq`, `chromadb`, `dotenv`, `ioredis`, `nanoid`, `pino`

В `devDependencies` остались: `@types/*`, `tsx`, `typescript`, `vitest`

### Fix 4 — Entrypoint extraction
Созданы:
- `src/main.ts` — entry для orchestrator (`node dist/main.js`)
- `src/queue-main.ts` — entry для queue worker (`node dist/queue-main.js`)

Из `orchestrator_v4.ts` и `task_queue.ts` удалены `main()` вызовы. Раскомментированы exports:
```typescript
export { MVPOrchestrator };  // orchestrator_v4.ts
export { FeatureQueue };     // task_queue.ts
```

`package.json` scripts обновлены:
```json
"start": "node dist/main.js",
"start:queue": "node dist/queue-main.js"
```

### Fix 5 — `vector_store.ts:243`: replaceAll
```typescript
// До
const name = `agent_${agentId.replace("-", "_")}`;

// После
const name = `agent_${agentId.replaceAll("-", "_")}`;
```

### Fix 6 — Gemini cost calculation
```typescript
// До
const cost = calculateCost("sonnet", { ...tokens, cacheRead: 0 }); // approximate

// После
const geminiPricing = MODEL_PRICING.gemini;
const cost = {
  total:
    (geminiPricing.input / 1_000_000) * tokens.input +
    (geminiPricing.output / 1_000_000) * tokens.output,
};
```

### Fix 7 — Extended thinking: убран `as any`
```typescript
// До
(params as any).thinking = { type: "enabled", budget_tokens: task.thinkingBudget };

// После
(params as Anthropic.MessageCreateParamsNonStreaming & {
  thinking: { type: "enabled"; budget_tokens: number };
}).thinking = { type: "enabled", budget_tokens: task.thinkingBudget };
```

### Fix 8 — `mcp_framework_v4.ts`: playwright package + shadcn добавлен
```typescript
// До
args: ["-y", "@anthropic/mcp-playwright"]

// После
args: ["-y", "@playwright/mcp@latest"]

// Добавлен новый сервер:
"shadcn-mcp-server": {
  command: "npx",
  args: ["-y", "@jpisnice/shadcn-ui-mcp-server"],
}
```

### Fix 9 — `sub_agents_config.ts`: имя MCP сервера
```typescript
// До
mcpServers: ["filesystem-mcp-server", "shadcn"]

// После
mcpServers: ["filesystem-mcp-server", "shadcn-mcp-server"]
```

### Fix 10 — Architect schema: reconcile
`buildArchitectPrompt()` в `orchestrator_v4.ts` обновлён — теперь запрашивает поля, которые ожидают `HANDOFF_RULES`:
`componentGuidelines`, `stateGuidelines`, `apiContracts`, `apiDesign`, `securityRequirements`, `dataRequirements`, `indexHints`, `performanceTargets`, `testScenarios`, `criticalPaths`

### Fix 11 — `turbo.json`: start:queue dependsOn
```json
"start:queue": {
  "dependsOn": ["build"],
  "cache": false,
  "persistent": true
}
```

### Fix 12 — `docker-compose.yml`: healthchecks + postgres:17
- `postgres:16-alpine` → `postgres:17-alpine`
- Добавлены `healthcheck` на все 3 сервиса (postgres, redis, chromadb)

### Fix 13 — `.env.example`: BASE_URL
```env
BASE_URL=http://localhost:3000   # Used by regression testing engine
```

---

## 5. Открытые вопросы (не фиксили — архитектурные решения)

| Вопрос | Описание | Рекомендация |
|--------|----------|--------------|
| Dual-protocol | `.md` агенты и TypeScript config расходятся | Генерировать `.md` из `sub_agents_config.ts` или сделать единый YAML source of truth |
| Budget persistence | `monthlySpend` сбрасывается при рестарте воркера | Хранить в Redis (уже в стеке), не в ChromaDB |
| Context-manager | Незадокументированный 7-й агент | Создать `context-manager.md`, добавить в `orchestrator.md` таблицу агентов |
| ChromaDB как session store | Неподходящий инструмент для KV-данных | Перенести session state в Redis, ChromaDB — только для semantic search |

---

## 6. Финальная структура файлов

```
.mcp.json                              ← 5 MCP серверов (filesystem, postgres, git, playwright, shadcn)
.env.example                           ← DATABASE_URL, AI vars, BASE_URL, REDIS_URL, CHROMA_URL
docker-compose.yml                     ← postgres:17, redis:7, chromadb + healthchecks
turbo.json                             ← typecheck, start:queue (dependsOn: build)

.claude/agents/
├── orchestrator.md                    ← существующий, не менялся
├── architect.md                       ← новый
├── frontend-ui.md                     ← новый
├── frontend-bizlogic.md               ← новый
├── backend-api.md                     ← новый
├── backend-database.md                ← новый
└── qa-testing.md                      ← новый

packages/ai-agents/
├── package.json                       ← @core/ai-agents, все runtime deps в dependencies
├── tsconfig.json                      ← NodeNext moduleResolution
├── .env.example
└── src/
    ├── main.ts                        ← новый entry point (orchestrator)
    ├── queue-main.ts                  ← новый entry point (queue worker)
    ├── types.ts
    ├── sub_agents_config.ts           ← shadcn-mcp-server имя исправлено
    ├── orchestrator_v4.ts             ← main() удалён, export раскомментирован, schema fixed
    ├── mcp_framework_v4.ts            ← playwright пакет исправлен, shadcn добавлен
    ├── vector_store.ts                ← replaceAll fix
    ├── task_queue.ts                  ← main() удалён, export раскомментирован
    ├── telegram_bot_handler.ts
    └── regression_testing_v4.ts
```
