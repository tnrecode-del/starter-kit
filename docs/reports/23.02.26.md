# Отчет о разработке: 23 Февраля 2026 г.

## Решенные проблемы и достижения (Оркестратор v4)

Во время отладки `ai-agents` Оркестратора и запуска очереди задач мы столкнулись с рядом серьезных невидимых фоновых сбоев, которые не давали задачам пройти полный цикл от `PENDING` до `COMPLETED`. Вот список того, что было обнаружено и исправлено:

### 1. Segmentation Fault (ChromaDB Embeddings Crash)

- **Проблема:** Библиотека `chromadb-default-embed` вызывала тихий краш Node.js (Segmentation Fault) на MacOS во время `postinstall` или попытки загрузить модель при старте `Phase 0`.
- **Решение:** Полностью удален `chromadb-default-embed`. Вместо него в `VectorStore` (пакет `ai-agents`) написана собственная интеграция с `@google/generative-ai`, которая генерирует эмбеддинги для векторной базы ChromaDB напрямую через модель `text-embedding-004` по ключу Gemini.

### 2. 401 Unauthorized от Anthropic (Fallback на Gemini)

- **Проблема:** После успешного прохождения `Phase 0` (генерация спецификации), агент Архитектор и другие сложные узлы пытались обратиться к Claude (Opus/Sonnet) и получали ошибку `401 - invalid x-api-key`, так как в `.env` был мок-ключ `ANTHROPIC_API_KEY=sk-ant-...`.
- **Решение:** Добавлен переключатель провайдеров `DEFAULT_AI_PROVIDER="gemini"` в `.env`. Оркестратор теперь мапит запросы:
  - Claude 3.5 Sonnet / Opus ➡️ **Gemini 2.5 Pro**
  - Claude 3.5 Haiku ➡️ **Gemini 2.5 Flash**
    Это позволило Оркестратору работать полностью автономно на одном бесплатном ключе от Google AI Studio.

### 3. Google Gemini Model "404 Not Found"

- **Проблема:** QA-агент падал в фазе верификации (`Phase 2`) с ошибкой `404 Not Found`, потому что Google отключила возможность использовать старую модель `gemini-2.0-flash` для новых пользователей.
- **Решение:** Модель в диспетчере (метод `dispatchToGemini`) была заменена на актуальную `gemini-2.5-flash`.

### 4. Ошибки сохранения VectorStore ("Collection not found")

- **Проблема:** В конце цикла задачи Оркестратор падал при попытке сохранить чекпоинты с ошибкой `Collection not found: agent_orchestrator`.
- **Решение:** В процесс инициализации ChromaDB (`getOrCreateCollection`) добавлены недостающие коллекции для `agent_orchestrator` и `agent_context_manager`.

### 5. Скрипт фильтрации очереди

- Для удобного управления очередью задач был написан скрипт `filter_queue.ts` в `packages/database`.
- **Использование:**
  ```bash
  cd packages/database
  export $(cat ../../.env | grep -v '^#' | xargs) && pnpm tsx filter_queue.ts IN_PROGRESS
  ```
  (_Позволяет фильтровать по PENDING, IN_PROGRESS, FAILED, COMPLETED_).

---

## Текущий статус:

- Оркестратор (v4) отлажен, работает стабильно и полностью автономно.
- Первые 4 мета-задачи полностью выполнены Оркестратором (`COMPLETED`), включая:
  - `feat-0`: Установка соединения с базой данных
  - `feat-1`: Актуализация схемы базы данных
  - `feat-2`: Сохранение данных между перезапусками сервера
  - `feat-3`: Отсутствие мок-паттернов в кодовой базе
- Задача `feat-4` (Backend API queries real database) в данный момент находится в статусе `IN_PROGRESS` и разрабатывается агентами.
