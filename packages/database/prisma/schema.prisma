generator client {
  provider = "prisma-client"
  output = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      ROLE?    @default(USER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model VerificationToken {
  identifier String
  token String @unique
  expires DateTime
  @@unique([identifier, token])
}

enum ROLE {
  ADMIN
  USER
}

model FeatureQueue {
  id           String   @id @default(cuid())
  featureId    Int      @unique
  name         String
  category     String
  status       String   @default("PENDING")
  priority     String   @default("MEDIUM")
  dependsOnIds Int[]
  testSteps    String
  resultData   String?
  executionLog String?
  retryCount   Int      @default(0)
  abortReason  String?
  
  executionMetric ExecutionMetric?
  roiMetric       RoiMetric?
  codeMetric      CodeMetric?
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model ExecutionMetric {
  id               String   @id @default(cuid())
  featureId        String   @unique
  feature          FeatureQueue @relation(fields: [featureId], references: [id], onDelete: Cascade)
  
  totalCostUsd     Float
  durationSeconds  Int
  successRate      Int
  readyForProduction Boolean
  promptTokens     Int
  completionTokens Int
  cachedTokens     Int
  agentsUsed       Json
  
  timestampStart   DateTime?
  timestampEnd     DateTime?
  budgetLimitUsd   Float?
  budgetRemainingUsd Float?
  createdAt        DateTime @default(now())
}

model RoiMetric {
  id               String   @id @default(cuid())
  featureId        String   @unique
  feature          FeatureQueue @relation(fields: [featureId], references: [id], onDelete: Cascade)
  
  filesModified    Int?
  gitBranch        String?
  toolsCalled      Int?
  estimatedHumanHoursSaved Float?
  savedHumanHours          Float?
  roiRatio                 Float?
  createdAt        DateTime @default(now())
}

model CodeMetric {
  id               String   @id @default(cuid())
  featureId        String   @unique
  feature          FeatureQueue @relation(fields: [featureId], references: [id], onDelete: Cascade)
  
  filesCreated     Int      @default(0)
  filesDeleted     Int      @default(0)
  linesAdded       Int      @default(0)
  linesRemoved     Int      @default(0)
  
  testCoverageBefore Float?
  testCoverageAfter  Float?
  
  typeErrorsBefore   Int?
  typeErrorsAfter    Int?
  
  lintErrorsBefore   Int?
  lintErrorsAfter    Int?
  
  securityFlags      String[]
  architectApproved  Boolean?
  
  createdAt        DateTime @default(now())
}